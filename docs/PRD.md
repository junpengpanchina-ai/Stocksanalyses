## PRD：K线智能分析网站（Java 模型核心）

### 1. 背景与目标
- 核心目标：用可解释的K线形态+趋势/量价/筹码/风险控制，做出“可回测、可模拟、可预警、可解释”的实盘级智能分析与策略平台。
- 指导思想：融合经典形态学（蜡烛图、道氏/趋势、波段）、统计/量化验证（稳健回测）、行为金融（情绪与偏差）、风险与资金管理（卡玛、回撤控制）。
- 成果物：
  - 面向交易者的“信号+解释+风险”一体化决策面板
  - 策略组件化（形态/指标/趋势/资金/仓位/风控）
  - 高吞吐低延迟数据通道与回测引擎
  - 可扩展的Java模型核心（在线/离线一致）

### 2. 目标与非目标
- 目标
  - 基于K线/量价/形态的信号生成与多周期确认
  - 一键回测/复盘/走查，含交易成本与滑点建模
  - 事件驱动的预警（多因子共振触发）
  - 可解释报告：引用形态、统计显著性、样本规模、极端行情表现
  - 风险控制内置：最大回撤、目标波动、头寸规模、止盈止损
- 非目标（V1不做）
  - 高频/毫秒级撮合
  - 复杂衍生品定价/希腊字母对冲
  - 社交交易/自动跟单

### 3. 用户与场景
- 用户画像
  - 主观交易者：看形态、看趋势，重解释和确认
  - 系统化交易者：重回测与稳定执行
  - 量化研究员：重因子拆解与统计稳健性
- 核心场景
  - 日内/日线多周期联动筛选
  - 形态出现→因子共振→风险评估→下单建议
  - 策略开发→参数搜索→多市场/多周期回测→出报告
  - 实时预警：盘中推送与风控阈值触发

### 4. 竞争与差异化
- 竞品：同类图表/指标网站、简单信号推送工具、传统回测器
- 差异化
  - 形态学“学术化”与量化验证结合（形态+统计显著性）
  - 解释层面系统化（引用形态、成功率、置信区间、极端行情表现）
  - 统一Java核心：回测=实盘逻辑一致、可插拔策略图谱
  - 风控与仓位原生内置（非附加）

### 5. 功能需求

#### 5.1 MVP（V1）
- 图表与数据
  - 多市场/多周期K线（1m/5m/15m/60m/D/W/M）
  - 主流指标：MA/EMA/MACD/RSI/KDJ/BOLL/ATR/VWAP
  - 事件标记：信号点、进出场、止盈止损
- 形态识别与因子
  - 蜡烛形态库：吞没、十字、锤子/上吊、启明星、黄昏星、三内/外、三只乌鸦等（可拓展）
  - 趋势结构：波峰波谷、通道、箱体、趋势线/突破、回撤/反抽
  - 量价行为：放量突破、缩量回调、OBV、累积/派发
- 策略与回测
  - 规则引擎：形态触发+趋势确认+量价共振+风险过滤
  - 回测器：事件驱动撮合（OHLCV）、滑点/手续费、分红/复权
  - 业绩指标：年化、夏普、卡玛、最大回撤、胜率、期望、换手
- 预警与通知
  - 条件：多因子阈值、级联确认、风控触发
  - 渠道：站内、邮件、Webhook
- 可解释性
  - 每次信号给出：形态截图、规则链路、样本统计、过往表现分布
- 风险与仓位
  - 固定比例、Kelly（稳健版）、波动率目标、ATR止损/跟踪止盈
- 策略市场
  - 策略模板库（形态驱动、趋势跟随、均值回归）与参数化配置

#### 5.2 V1.1+
- 强化学习或Bandit做策略选择/权重分配（可选线上A/B）
- 因子稳定性分析（IC/IR、滚动窗口）
- 资金分配器（多标的/多策略的组合优化，风险预算）
- 新闻/情绪数据融合（可插拔）

### 6. 非功能需求
- 性能
  - 实时信号延迟 ≤ 2s（从新K线落地开始）
  - 回测吞吐：≥ 5,000,000 K线/分钟（单机）
- 可用性/SLO
  - 后端99.9%月度可用性
  - 数据一致性：最终一致，回测数据可重放
- 安全与合规
  - 只做研究与辅助决策，不提供个股“买卖建议”
  - 数据来源合规、缓存加密、审计日志
- 可维护性
  - 策略/形态/因子插件化、API稳定、版本化

### 7. 数据与来源
- 行情数据
  - 实时：交易所合规源/聚合商（WebSocket+REST）
  - 历史：官方/商业供应商，统一到OHLCV+企业行动（拆分/分红）
- 存储
  - 行情时序：TimescaleDB(PostgreSQL) 或 ClickHouse
  - 元数据/账户/策略：PostgreSQL
  - 归档/重放：对象存储（S3兼容，Parquet）
- 数据校验
  - 多源对账、异常K线修复、交易日历校准、复权一致性

### 8. 技术架构（Java为模型核心）
- 总体
  - 前端：Next.js + ECharts（或 TradingView widget）
  - API：Spring Boot（微服务化可演进到 Spring Cloud/Quarkus）
  - 流处理：Kafka（行情→清洗→指标→信号）
  - 存储：TimescaleDB/ClickHouse + PostgreSQL + Redis（热Key/队列）
  - 作业：Airflow（回测、日终任务、因子计算）
  - 模型核心（Java库，JAR形式供API与回测共享）：
    - 技术指标/形态：ta4j + TA-Lib(JNI)
    - 趋势/结构：自研模块（波峰谷/通道/突破检测）
    - 策略引擎：Drools（规则）或自研DSL（更透明）
    - 优化/搜索：JMH基准、并行参数搜索、粒子群/网格搜索
    - 可解释性：因子贡献、形态证据、样本统计
    - 学习组件（可选）：Tribuo/DeepLearning4J（轻量模型）
- 关键特性
  - “同一Java核心”被API与回测器复用，保证线上/离线一致
  - 事件流驱动：K线落地→指标计算→形态检测→规则→信号→预警
  - 插件化SPI：形态、指标、过滤器、风控器、进出场器

### 9. 核心域模型（简化）
- Entities
  - Instrument(symbol, exchange, assetClass)
  - Candle(ts, open, high, low, close, volume)
  - IndicatorResult(name, value, window, ts)
  - PatternSignal(name, strength, confidence, ts, evidence)
  - StrategyConfig(params, rules, riskPolicy, positionSizer)
  - BacktestResult(metrics, trades[], equityCurve, drawdowns)
  - Alert(ruleId, signalId, channel, status)
- 边界
  - OnlineSignalService 使用同一 StrategyEngine（Java）生成实时信号
  - BacktestService 调用同一核心的“离线模式”

### 10. 关键API（示例）
- GET `/api/instruments?query=...`
- GET `/api/candles?symbol=...&interval=1d&start=...&end=...`
- POST `/api/strategy/backtest`
  - body: { strategyConfig, universe, interval, start, end, costModel, slippageModel }
- POST `/api/strategy/run-live`
  - body: { strategyConfig, universe, interval }
- GET `/api/signals?symbol=...&start=...&end=...`
- POST `/api/alerts`
  - body: { conditions, channels }
- GET `/api/explain?signalId=...`
  - returns: { rulesFired[], evidence[], stats, historicalDistribution }

### 11. 策略与规则规范
- 形态识别（库）
  - 蜡烛形态枚举与参数：最少样本、实体比例、影线比例、相对ATR过滤
  - 趋势确认：MA坡度、Higher High/Low、通道突破回抽二次确认
  - 量价共振：放量阈值（z-score/分位数）、成交额过滤
- 风险与仓位
  - 头寸：波动率目标、ATR头寸、Kelly上限（半Kelly）
  - 止损/止盈：固定/ATR追踪/分级减仓
  - 组合：标的相关性约束、风险预算（V1.1）
- 解释输出
  - firedRules、形态证据（K线标注、比例）、样本统计（胜率/盈亏比/窗口N）
  - 报告引用对应理论条目（形态定义/适用市场/常见失败模式）

### 12. 回测与验证
- 数据：前复权/后复权可选，成交额过滤，ST/停牌剔除，可配置滑点/费用
- 指标：年化、最大回撤、卡玛、Calmar、Sortino、月度分布、极端日表现
- 抗过拟合：样本外/滚动验证、时间阻塞交叉验证、参数稳定性热图
- 稳健性：不同市场/周期/成本/滑点敏感性测试

### 13. UI/UX 关键页面
- 标的看板：多周期K线、信号叠加、形态标注、量价概览
- 策略编辑器：可视化规则链+参数，实时回测摘要
- 信号收件箱：按强度/置信度/风险评级排序，可批量订阅预警
- 解释报告：形态截图、证据、统计、历史表现与极端行情子集
- 组合面板：收益/回撤/换手/风控阈值展示

### 14. 里程碑与验收
- M0（2周）：数据接入与清洗管道、K线服务、基础图表
- M1（4周）：Java模型核心（指标/形态/规则/风控）+ 回测器
- M2（3周）：实时信号/预警、解释报告、策略编辑器V1
- M3（2周）：参数搜索、性能优化、SLO与监控
- 验收标准（选摘）
  - 实时信号端到端 ≤ 2s；回测性能达到指标
  - 至少20种形态、≥10个指标、3类风控策略可插拔
  - 回测与线上同策略的信号一致率 ≥ 99.5%
  - 解释报告覆盖率 100%，含样本统计与失败模式提示

### 15. 风险与应对
- 数据质量/漂移：多源对账、异常修复、质量告警与回放
- 过拟合：滚动验证、简单而稳健的规则优先
- 监管与合规：免责声明、功能定位为研究与辅助，不提供个股建议
- 性能瓶颈：指标批处理向量化、列式引擎（ClickHouse）、热点缓存
- 可解释性冲突：限制黑箱模型范围，保持规则链透明

### 16. 技术选型（建议）
- 后端：Spring Boot 3、Java 21、Gradle/Maven
- 指标/形态：ta4j + TA-Lib(JNI)，自研趋势/结构模块
- 规则：Drools 或轻量DSL（YAML/JSON）→ 生成可执行规则树
- 数据库：TimescaleDB（时序）+ PostgreSQL（交易/配置）、Redis（缓存）
- 流：Kafka、Schema Registry（Avro/Protobuf）
- 作业/回测：Airflow + 自研回测器（Java），Parquet归档
- 前端：Next.js + ECharts/TradingView、Tailwind
- 监控：Prometheus + Grafana，OpenTelemetry

### 17. Java 模型核心分层（代码结构建议）
- `core-indicators`: 指标与窗口计算（ta4j包装、批处理）
- `core-patterns`: 蜡烛/趋势/量价形态检测（参数化、统计校验）
- `core-strategy`: 规则组合、过滤链、信号打分、解释构建
- `core-risk`: 头寸、止损止盈、资金曲线控制
- `core-backtest`: 撮合、成本/滑点、复权、绩效指标
- `core-explain`: 证据、样本统计、可追溯链路
- `core-spi`: 插件与扩展协议（加载/版本/灰度）
- `core-io`: Kafka/DB/Parquet 适配器（离线/在线一致）

### 18. 示例策略（MVP内置）
- 形态突破趋势跟随：看涨吞没 + 均线多头 + 放量突破 + ATR止损
- 回调买入：上升趋势中的锤子线回调+缩量+反包确认
- 均值回归：布林带下轨超卖 + RSI背离 + 反弹止盈

### 19. 成功度量
- 研究侧：回测样本≥10年、样本外稳健、参数不敏感
- 业务侧：日活研究用户、回测完成时长、预警点击/留存
- 技术侧：SLO达标、信号一致率、扩展插件数

### 20. 后续演进
- 多资产：期货、数字资产、外汇（交易日历/时区适配）
- 组合优化：风险平价、最小方差、CVaR约束
- 在线学习/权重自适应（严格监控可解释与漂移）


