<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KLine Upload</title>
  <link rel="stylesheet" href="/styles.css" />
  </head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand"><div class="dot"></div><h1>KLine Analytics</h1></div>
      <div class="toolbar">
        <a class="btn" href="/swagger-ui/index.html">API</a>
        <a class="btn" href="/docs/PRD.md">PRD</a>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Upload & Analyze</h3>
        <div class="content">
          <div class="drop" id="drop">Drop image here or choose file</div>
          <div class="imgbox" id="imgbox"><img id="preview" alt="preview" /></div>
          <div class="inputs">
            <input type="file" id="file" accept="image/*" />
            <button class="primary" id="send">Analyze</button>
            <span class="badge"><span class="k k-buy"></span> BUY / <span class="k k-sell"></span> SELL</span>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Result</h3>
        <div class="content">
          <div class="signal-card" id="signalCard">
            <div class="signal-title">
              <strong id="sigLabel">—</strong>
              <span class="pill pill-neutral" id="sigPill">NEUTRAL</span>
            </div>
            <div class="bar"><span id="sigBar"></span></div>
            <div class="legend">Strength, explanation appears below.</div>
          </div>
          <pre class="mono" id="out">{ /* Result will appear here */ }</pre>
        </div>
      </div>
    </div>

    <footer>Theme: Terminal Pro · © KLine Analytics</footer>
  </div>
  <script>
    const fileInput = document.getElementById('file');
    const drop = document.getElementById('drop');
    const out = document.getElementById('out');
    const sendBtn = document.getElementById('send');

    ;['dragenter','dragover','dragleave','drop'].forEach(e => {
      drop.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); }, false);
    });
    drop.addEventListener('drop', ev => { fileInput.files = ev.dataTransfer.files; onFileChange(); }, false);
    fileInput.addEventListener('change', onFileChange);

    function onFileChange(){
      const f = fileInput.files && fileInput.files[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      const img = document.getElementById('preview');
      img.onload = () => URL.revokeObjectURL(url);
      img.src = url;
    }

    sendBtn.onclick = async () => {
      if (!fileInput.files || !fileInput.files[0]) { alert('Choose a file'); return; }
      const fd = new FormData();
      fd.append('file', fileInput.files[0]);
      const x1 = document.getElementById('x1')?.value;
      const y1 = document.getElementById('y1')?.value;
      const p1 = document.getElementById('p1')?.value;
      const x2 = document.getElementById('x2')?.value;
      const y2 = document.getElementById('y2')?.value;
      const p2 = document.getElementById('p2')?.value;
      if (x1 && y1 && p1) { fd.append('calibX1', x1); fd.append('calibY1', y1); fd.append('calibPrice1', p1); }
      if (x2 && y2 && p2) { fd.append('calibX2', x2); fd.append('calibY2', y2); fd.append('calibPrice2', p2); }
      // strategy params
      const addIf = (k, elId) => { const v = document.getElementById(elId)?.value; if(v) fd.append(k, v); };
      addIf('emaShort','emaShort'); addIf('emaLong','emaLong');
      addIf('macdFast','macdFast'); addIf('macdSlow','macdSlow'); addIf('macdSignal','macdSignal');
      const res = await fetch('/api/upload/analyze', { method: 'POST', body: fd });
      const json = await res.json();
      out.textContent = JSON.stringify(json, null, 2);
      // Update signal card
      const signals = json.signals || [];
      if (signals.length) {
        const s = signals[0];
        document.getElementById('sigLabel').textContent = `${s.type} · ${s.strength?.toFixed ? s.strength.toFixed(2) : s.strength}`;
        const pill = document.getElementById('sigPill');
        pill.className = 'pill ' + (s.type === 'BUY' ? 'pill-buy' : s.type === 'SELL' ? 'pill-sell' : 'pill-neutral');
        pill.textContent = s.type;
        const width = Math.min(100, Math.max(5, (s.strength || 0) * 10));
        document.getElementById('sigBar').style.width = width + '%';
        // explanation
        const explainEl = document.createElement('div'); explainEl.className = 'explain'; explainEl.textContent = s.explanation || '';
        document.getElementById('signalCard').appendChild(explainEl);
      }
      // Draw overlays guides
      const imgbox = document.getElementById('imgbox');
      // remove old guides
      imgbox.querySelectorAll('.guide,.guide-label').forEach(el=>el.remove());
      const overlays = json.overlays || {};
      const guides = overlays.guides || [];
      guides.forEach(g=>{
        if(g.type==='hline' && typeof g.y === 'number'){
          const gl = document.createElement('div'); gl.className='guide'; gl.style.top = g.y+'px';
          const label = document.createElement('div'); label.className='guide-label'; label.textContent = g.label || '';
          imgbox.appendChild(gl); imgbox.appendChild(label);
          label.style.top = (g.y-10)+'px';
        }
      });
      if (json.pipeline && String(json.pipeline).includes('OCR')){
        const badge = document.createElement('span'); badge.className='pill pill-neutral ocr-badge'; badge.textContent='OCR inferred';
        document.querySelector('.inputs').appendChild(badge);
      }
    };

    // Calibration simple inputs
    const calibBlock = document.createElement('div');
    calibBlock.className = 'content';
    calibBlock.innerHTML = `
      <div class="calibrate">
        <span style="color:var(--muted)">Calibrate (optional):</span>
        <input id="x1" placeholder="x1" />
        <input id="y1" placeholder="y1" />
        <input id="p1" placeholder="price1" />
        <input id="x2" placeholder="x2" />
        <input id="y2" placeholder="y2" />
        <input id="p2" placeholder="price2" />
      </div>
      <div class="params">
        <span style=\"color:var(--muted)\">EMA/MACD:</span>
        <input id=\"emaShort\" placeholder=\"emaShort 20\" />
        <input id=\"emaLong\" placeholder=\"emaLong 50\" />
        <input id=\"macdFast\" placeholder=\"macdFast 12\" />
        <input id=\"macdSlow\" placeholder=\"macdSlow 26\" />
        <input id=\"macdSignal\" placeholder=\"macdSignal 9\" />
      </div>`;
    document.querySelectorAll('.card .content')[0].appendChild(calibBlock);

    // Click-to-calibrate
    const imgbox = document.getElementById('imgbox');
    const mark1 = document.createElement('div'); mark1.className = 'mark'; imgbox.appendChild(mark1);
    const mark2 = document.createElement('div'); mark2.className = 'mark mark2'; imgbox.appendChild(mark2);
    let selectIdx = 1;
    imgbox.addEventListener('click', (e)=>{
      const rect = imgbox.getBoundingClientRect();
      const x = e.clientX - rect.left; const y = e.clientY - rect.top;
      if(selectIdx===1){
        document.getElementById('x1').value = Math.round(x);
        document.getElementById('y1').value = Math.round(y);
        mark1.style.left = x+'px'; mark1.style.top = y+'px';
        selectIdx = 2;
      } else {
        document.getElementById('x2').value = Math.round(x);
        document.getElementById('y2').value = Math.round(y);
        mark2.style.left = x+'px'; mark2.style.top = y+'px';
        selectIdx = 1;
      }
    });
  </script>
</body>
</html>


